/*
    Written by Andreas Mieke         ,         L, do you know
    2017, Public Domain              8                Gods of death love apples?
                                 I : O  : O                  — Kira
                                 I ,+ZD= O8
                               ++Z8Z7ODO$88N D
                              +I7ZZOZODON88N,N I
    :ZD,       7?   D :       =:OZZZZZD88DDDNDN
         87        N8 8D      ?OZZZZZO88DDNDNON  :
            MMNNDDDD NDDN7   I?ZOOZZZOO8DDNNNNN O      D    ~8I
                +MNNNNNDNND8 Z$ZNDOZZOODNNNNNNNN  ~ DND   NN
         DDDMMNNNNNNNNNNNNNNM7O8D+,8OONNDDNNNNN? NNNNNNNMNN~     =8
     ZN:     8NNNNNNMNNNNNNNNOD8Z,,,=8D,~8DNNNNNNNNNNMNNNMNNND8
  ,       :8NMN  DDDDNNNNNNNNN8D~,:,,$ ,,?DDNNNNNMMMNNNNNNDDNNNNN=
        $NO  O8DDNNDNNMNNN8Z?I$D?,,:,,,+,~8DNND8DNNMNNNNNDDNMM8~ NNN+N?
     =     8ODNN=DNNNNNNNI=~=$IIIOO+,,,??$D8IIOZ$777NNNNMMMMN8, MD,  :8
          DMN  8N8NNDNNN8,,::~8D,O$$$Z$OI?ZZ=$$77I7DNNNNNNNMMNM8   NN   8
         NN  ON:D8D8DNNDNZO7I?~+,,,,,  , IZZII77 IINMNNNNNNDNNN8M=   =M
        NI  D  N8DONNDNDDNDD,,:Z8+7,7,I  O?= =  ?8NNNNNNNDMMM8N,ND=    $
       N   D  D NZNN8NNONND8,,,,~:888OO8DZO:  ~+$8NNNNDNNNDNNNNN  M8
      N   N  O 8NNNNNNONNDDD8$,,,O 8DDDDDO$?+++$DNNNNNN8NNNNDNN N  N8
             Z+NDNDNNNDNZD88OZOOII$,I88D8$7IZ??ONNNNNNDNONNNNNNN N N D
   7     ~    N7DODNNNN D NNZ$7$D88Z   O8Z7NODNNNNNNNNNNNNNNNNNO  ,   Z
        D   ~ $ZN8DNMN  Z  MNZ$$7NNNNDDDNNNNNNNNNMDNNNNNMMMMMMND8      +
           , $ZZ8MMZ N  ,    NNO$$$$DNNNNNNNMMNNZONNNNNMMMMMMMMNZD $~
          I  $OONM=            NNNNNNNMMNNNNNNMMMNN         MMMNOZO
            $$NN88             DNNNNNNNNNNNNNNNNN            NNNNN$
           $$$ZNN               OONNNNNNNNNNNNN8$             NNNOZ7
          777$Z8+                ZNNNNNNNNNNNNNZ               NN$$$$
        $$$$NNNN                 $NNNNNNNNNNNNN:               ZNNN$77
        $$ZNNN                   ZNNNNNNNNNNNNN8                NNNNN$: 8
       7ZNNNND                IIZZNNNNNNNNNNN$ZNO               +MNNNZ$$$
       8Z$$$N8               DO$$$$8NNNNNNOZZDNN$ZNZ              NNN$N$Z
      ,O$$ONO                DZ+NNNN$NNNNNNNNNN8$NZO              =NNNZD$~
      Z$$$Z$NN              $O+~ZNNNNNNNNNNNNN$ONDOD~              NNNDNZ
       =N$8NNN              $:+8DDZND8ZZDNNNNNNOODNNO             INONNNDZ
       $ Z$NNN            DO$?:ON88D+=7+88D8DN88NNZMND            NNNNNND D
        7?$$$N           DDD8DDNDN$8$7$7O8ODDDND,NNNNNZ           NNNNN$
          $$$N+         NDNDD:NNDDDDD8$NNDNNNON$8NNNNNND          NNNNN$
          $$$NO       DDDNNDNNNNDDDDDDNDDN$MDDDNNNNNNNND          ?NNNDO
          +$DDN      ZNNNNNNINNNDNDDDNNNDDDN:DDNNNNNNNZO$          NND$,
           NONN      N DNNNDNNNDDNDDDNNNDDDNNN~NNNNNN=$$?          NNN$
           $$NN     D~~7NNNNNNNDDNDDNNNNNDDNNDDNNZNNNN88ZO?        NN$$
            $NN    O  NN8DNMNNNDDNDNNNNNNDDNNNDNNNNN$888ZOO        NNZ$
            $$ND  =  DNO8NNNNNNNNNDNNNNNNDDNNNDNNNNNNNZDNZN$       NNN$
            $$$N     NZODNNNNN=8N~DDNN8N DD 7NDNNNNNNNNDNND8?     ,NNDZ
            7ZNNO    DZ8NNNNN  ON ZD8    NN  NNNNNNNNDNNNNNOD     $NNN8
             OD8N   NZNNNNNN:   N  N     NN   DD?NNNN88NNNDNOZ    DNN$7
             ,ODN   $DNNNNN     +  N     D:   N  NNNNDOZZNN+,     NNN$
             ?ZO:O $$$DN8N      +  D          +   DNNN8ZZ$$       NN$$
           ~Z7ZDODD$$DNNN                          NNNNNZ$8      ,NN$$
           ~88NDNN$$$NNNN                          ~NNNNN$$      7DDZ$Z
             DNZ$ZNNNNN7                             NNNN$$     DNNNN$
             O$$$$NNNNN                              ~NNN$$Z    NNDNND
             $$$$$$$ON                                $NNNZ$+ DNNNNNN$
             $$$$NNN$NN                                NNNNN7 NNZ$NNNN=
            7$$$DNNNNNN                                NNNNNNDN$$NNNDN$
            $$$$NZNNNNNN                                NNZ$$NN  NNNZN$
           $$D$$~ $NZDNN~                              DNNNN$N   ZNN$NDO
           O$OI8D  $$$NNN                              NNNNNNN    NDI887
           ==7+$O  $$$DNNN                             NNNNNNN    N7O~ 7
            8I8,8,  D$NNNN                             NNNN$$     N8DZ:
            ,8NN?ON8,$DNNN+                            NNNO$$   O8ODND
              ODNNNNNM$NNNN                            NNNN$     NZ NO
                NN  N 8$ONN                            NNNN$    NZ8NZ
                  N    NNNN                            NNN$$      D8
                       ON$N8                           NN8$~
                        $$NN                           NN$O
                        $$NN                          :NZN$
                        ZDNNN                         INN$
                        Z$NNN                         ONN8
                         $NNN                         NNN$
                         IZNNO                        NN$Z
                         ~$ZNNI                      NNN$Z
                         +NNNNN                      NNN8Z
                         Z8$ZN                       D8D$O
                         $N8N                        MDN$
                        $NNZ8                        ~ZNNO
                       =NNNN                         :NNN$
                       $NNNN                          NONZ
                       ZNNNN                          NDNN
                      $$NNN                           ONND
                      $NNN                             NND$
                      $NN                              8NN$
                      ?                                 =NZ
*/

/*
    Here begins the funny configuration stuff! Actually you just have to set the
    amount of apples Ryuk – ugh, I mean Sepp – will get, the port he will listen
    to and other stuff once I come up with it.
*/

#define APPLES_WANTED   100             // How many apples does Ryuk want?
#define PORT            8666            // On which port should he listen?
#define NUM_THREADS     10              // How many clients at one time?
#define RYUK_NAME       "Ryuk"          // If someone wants to call me Sepp,
                                        // change this line -.-
#define BUFFER_SIZE     2048            // String buffer for receiving

/*
    Thank you, human, for the configuration. Now the real magic begins!
*/

#define BACKLOG         10

#include <stdio.h>
#include <string.h>                     // strlen
#include <stdlib.h>
#include <sys/socket.h>
#include <arpa/inet.h>                  // inet_addr
#include <unistd.h>                     // write
#include <signal.h>                     // signal

#include <pthread.h>                    // Threading

#include <assert.h>                     // assert

long apples_left    =   APPLES_WANTED;  // Holds the number of apples to collect
int socket_fd;                          // Socket file descriptor
pthread_mutex_t apple_lock;             // Mutex for the apples_left counter

void *handle_socket(void *l_socket_fd);
void handle_int(int dummy);

int main(int argc, char const *argv[])
{
    int new_socket_fd, c, *new_sock;
    struct sockaddr_in server, client;
    char *msg;

    // SIGINT handler registration for graceful termination
    signal(SIGINT, handle_int);

    // Init the mutex for the apple_left counter
    if (pthread_mutex_init(&apple_lock, NULL))
    {
        perror("Could not create mutex");
        return 1;
    }

    // Create the server socket
    socket_fd = socket(AF_INET, SOCK_STREAM, 0);
    if (socket_fd == -1)
    {
        perror("Could not create socket");
        return 1;
    }

    // Address and port
    server.sin_family       = AF_INET;
    server.sin_addr.s_addr  = INADDR_ANY;
    server.sin_port         = htons(PORT);

    // Bind the socket
    if (bind(socket_fd, (struct sockaddr *)&server, sizeof(server)) < 0)
    {
        perror("Could not bind to socket");
        return 1;
    }
    puts("Bound to socket!");

    // Start listening on the bound socket
    listen(socket_fd, BACKLOG);

    puts("Waiting for connections...");
    puts(RYUK_NAME ": Please bring me some apples!");
    c = sizeof(struct sockaddr_in);
    // Wait for new connections and accept them
    while   ((new_socket_fd = accept(   socket_fd,
                                        (struct sockaddr *)&client,
                                        (socklen_t *)&c)
            ))
    {
        puts("Connection accepted!");

        pthread_t apple_thread;

        // Allocate memory for the thread argument
        new_sock = malloc(sizeof(int));

        // Set the argument for the thread to the socket file descriptor
        // of the newly accepted connection, so the thread can communicate
        // with the client that was just accepted
        *new_sock = new_socket_fd;

        // Create the thread for the accepted client. This thread will handle all
        // further communication with this client.
        if (pthread_create( &apple_thread,
                            NULL,
                            handle_socket,
                            (void *)new_sock)
            < 0)
        {
            perror("Could not create socket thread");
            return 1;
        }
        puts("Handler assigned");
    }

    if (new_socket_fd < 0)
    {
        perror("Could not accept connection");
        return 1;
    }

    // There is no valid condition that should bring us here, so
    // assert that we never reach this point of the program, so if we
    // ever do, we can easier debug it.
    assert(!"End of main should never happen");
}

// This function is used to communicate with a specific client
// that was accepted in our main loop, in a separate thread for
// each client.
void *handle_socket(void *l_socket_fd)
{
    int fd = *(int *)l_socket_fd, read_size, msg_id;
    char msg[BUFFER_SIZE], name[64], *tok;

    // Read data from the client
    while ((read_size = recv(fd, msg, sizeof(msg), 0)) > 0)
    {
        // Parse the message we got from the client
        // Look for the valid start sequence of the clients message
        tok = strchr(msg, '#');
        if (tok == NULL ||
            msg[0] != '$' ||
            msg[5] != ':' ||
            strncmp(tok, "#\r\n", 3) != 0)
        {
            // If there is no valid start sequence, print an error
            // and disconnect the client.
            puts("Wrong message format, disconnecting client!");
            close(fd);
            break;
        }

        // The first 4 bytes after the start sequence ($) hold the id of
        // the message that was sent.
        char id[5] = {msg[1], msg[2], msg[3], msg[4], 0};
        msg_id = atoi(id);

        // Next check the type of the message and the argument:
        // HELO
        if (strncmp(msg+6, "HELO;name=", 10) == 0)
        {
            tok = strchr(msg, '#');
            *tok = '\0';
            tok = strchr(msg, '=');
            strncpy(name, tok+1, sizeof(name));
        }

        // HAVE
        else if (strncmp(msg+6, "HAVE;apples=", 12) == 0)
        {
            tok = strchr(msg, '#');
            *tok = '\0';
            tok = strchr(msg, '=');
            int got = atoi(tok+1);

            // Lock the mutex for the apple_left counter
            pthread_mutex_lock(&apple_lock);
            // Substract apples we got from the apple_left counter
            // This needs to be done while the lock is hold, to ensure
            // that no other thread decrements the counter at the same
            // time, causing a data race.
            apples_left -= got;
            pthread_mutex_unlock(&apple_lock);
            printf(RYUK_NAME ": Got %dkg apples from %s, now I have %ldkg.\n",
                                got, name, APPLES_WANTED - apples_left);
        }

        // Check if we still need more apples
        if (apples_left > 0)
        {
            // If yes, ask for them
            sprintf(msg, "$%04d:NEED;apples=%ld#\r\n", msg_id, apples_left);
            write(fd, msg, strlen(msg));
        }
        else
        {
            // If not, we are done. Thank and disconnect the client.
            sprintf(msg, "$%04d:THNK#\r\n", msg_id);
            write(fd, msg, strlen(msg));
            close(fd);
            puts("Enough apples, disconnecting...");
            break;
        }
        memset(msg, sizeof(msg), 0);
    }
    if (read_size == 0)
    {
        puts("Client disconnected!");
    }
    if (read_size < 0)
    {
        perror("Receive failed");
        close(fd);
    }

    // Cleanup the socket
    free(l_socket_fd);
    return 0;
}

// SIGINT handler
void handle_int(int dummy)
{
    puts("\rReceived SIGINT, exiting now...");
    close(socket_fd);
    pthread_mutex_destroy(&apple_lock);
    exit(0);
}

/*
                   LLLLLLLLL8            L?     LLLLLLLN
                 LLLLLLLLLLLLLLLL: :ZLLLL,   LLLLLL
                LLLLLLLLLLLLLLLLLLLLLLL=  ,LLLLLL,
               LLLLLLLLLLLLLLLLLLLLLLL:   LLLLLLL
              LL      +LLLLLLLLL,LLLLL   LLLLLLL
                                LLLLL    LLLLLLL
Risking your life              NLLLLL    LLLLLLL
and doing something           LLLLLLL    LLLLLLL
that could rob you           OLLLLLLL   ,LLLLLLL
of your life are             LLLLLLLL    LLLLLLL+
exact opposites.             LLLLLLLL    LLLLLLL8
    — L                      LLLLLLLL    LLLLLLLL
                             LLLLLLLL    LLLLLLLL
                             LLLLLLLL    LLLLLLLL
                             LLLLLLLL    LLLLLLLL
                      ,=LLLLLLLLLLLLL~   LLLLLLLL
                    :LLLLLLLLLLLLLLLL8   LLLLLLLL
                    LLLLLLLLLLLLLLLLLL   LLLLLLLL
                          ZLLLLLLLLLLL   LLLLLLLL
                            DLLLLLLLLL   LLLLLLLN
                             LLLLLLLLL   LLLLLLL
                             7LLLLLLLL   LLLLLLL
                       LLLLLLLLLLLLLLI   LLLLLL
                       7LLLLLLLLLLLLL   ,LLLLL7
                           ~LLLLLLLLD   LLLLL
                             LLLLLLL   ZLLLL
                              LLLLL   +LLL,,
                              LLLLL   LLL
                              LLLL  ,LLL
                             LLLL  LLL   ILLLLLLLLLLL: ,
                             LLL  LLLLLLLLLLLLLLLLLLLLLLL,    ,
                           :LLLLLLLLLLLLLLLLLLLLLLLLLLLLLLLL=  LL
                          DLLLLLLLLLLLLLLLLLLLLLLLLLLLLLLLLLLLLZ
                         DLLLLLLLLLD$?~,,=IZLLLLLLLLLLLLLLLLLL,
                      ,?LLLL7                    ?LLLLLLLLLLZ
                     7NLL                            LLLLLL
                   8LL                                 LL=
*/
